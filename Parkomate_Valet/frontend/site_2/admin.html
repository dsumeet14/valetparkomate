<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard - Site 2</title>
  <link rel="stylesheet" href="../styles.css" />
  <style>
    /* Responsive table wrapper */
    .table-wrapper { width: 100%; overflow-x: auto; }

    /* Override for admin-specific tabs */
    .admin-tabs { margin-top: 16px; }
    .admin-tabs .tab { flex: 1; text-align: center; }

    /* Form inputs */
    form input, form select {
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
      margin-right: 6px;
      margin-bottom: 6px;
    }
    form { display: flex; flex-wrap: wrap; gap: 6px; align-items: center; }

    /* Tables */
    table { border-collapse: collapse; width: 100%; font-size: 14px; }
    th, td { border: 1px solid #e5e7eb; padding: 8px; text-align: left; }
    th { background: #f9fafb; font-weight: 600; }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .admin-tabs .tab { flex: 1 1 48%; } /* 2 per row */
      form { flex-direction: column; align-items: stretch; }
      form input, form select, form button { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="header card">
      <div class="h-title">
        <div class="logo">AD</div>
        <div>
          <h3 class="h1">Admin Dashboard</h3>
          <div class="small">Site 2</div>
        </div>
      </div>
      <div class="small">
        Signed in as <span id="who"></span>
        <button id="logoutBtn" class="btn secondary">Logout</button>
      </div>
    </header>

    <!-- Stats -->
    <div class="card" style="margin-top:16px">
      <h2>Site Stats</h2>
      <p id="siteStats">Loading...</p>
    </div>

    <!-- User Management -->
    <div class="card" style="margin-top:16px">
      <h2>User Management</h2>
      <form id="addUserForm">
        <input type="text" name="new_id" placeholder="User ID" required />
        <input type="password" name="password" placeholder="Password" required />
        <select name="role" required>
          <option value="operator">Operator</option>
          <option value="driver">Driver</option>
          <option value="manager">Manager</option>
          <option value="client">Client</option>
        </select>
        <button type="submit" class="btn">Add User</button>
      </form>
      <div id="addUserMsg" class="small"></div>

      <form id="removeUserForm" style="margin-top:10px;">
        <input type="text" name="user_id" placeholder="User ID" required />
        <button type="submit" class="btn secondary">Remove User</button>
      </form>
      <div id="removeUserMsg" class="small"></div>
    </div>

    <!-- Tabs -->
    <div class="card admin-tabs">
      <div class="tabs">
        <div class="tab active" data-tab="usersTab">Users</div>
        <div class="tab" data-tab="todayTab">Today’s Cars</div>
        <div class="tab" data-tab="historyTab">History</div>
        <div class="tab" data-tab="searchTab">Search</div>
      </div>
    </div>

    <!-- Users -->
    <div id="usersTab" class="tab-content card active">
      <h3>Current Users</h3>
      <div class="table-wrapper">
        <table id="usersTable">
          <thead>
            <tr><th>User ID</th><th>Role</th><th>Created At</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Today -->
    <div id="todayTab" class="tab-content card" style="display:none">
      <h3>Today’s Car Activity</h3>
      <div class="table-wrapper">
        <table id="todayTable">
          <thead>
            <tr>
              <th>Car No</th><th>Valet ID</th>
              <th>Driver (Park)</th><th>Driver (Bring)</th>
              <th>Status</th><th>Parking Spot</th>
              <th>In Time</th><th>Parked</th><th>Handed Over</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- History -->
    <div id="historyTab" class="tab-content card" style="display:none">
      <h3>Car History</h3>
      <input type="date" id="historyDate" />
      <button onclick="loadHistory()" class="btn">Load History</button>
      <div class="table-wrapper">
        <table id="historyTable">
          <thead>
            <tr>
              <th>Car No</th><th>Valet ID</th>
              <th>Driver (Park)</th><th>Driver (Bring)</th>
              <th>Status</th><th>Parking Spot</th>
              <th>In Req</th><th>Driver Assigned</th><th>Parked</th>
              <th>Out Req</th><th>Brought</th><th>Handed Over</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Search -->
    <div id="searchTab" class="tab-content card" style="display:none">
      <h3>Search Cars</h3>
      <div style="margin-bottom:10px;">
        <input type="text" id="searchQuery" class="input-sm" placeholder="Enter Car No / Valet ID" />
        <button onclick="searchCars()" class="btn">Search</button>
      </div>
      <div class="table-wrapper">
        <table id="searchTable">
          <thead>
            <tr>
              <th>Car No</th><th>Valet ID</th><th>Status</th><th>Parking Spot</th>
              <th>Driver (Park)</th><th>Driver (Bring)</th>
              <th>In Req</th><th>Driver Assigned</th><th>Parked</th>
              <th>Out Req</th><th>Brought</th><th>Handed Over</th>
              <th>Source</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Footer -->
    <div class="footer">Parkomate • Admin • Site 2</div>
  </div>

  <!-- Scripts -->
        <script src="../config.js"></script>
  <script src="../scripts.js"></script>
  <script>
    const site_no = 2;
    const admin_id = localStorage.getItem('userId');
    document.getElementById('who').innerText = `${admin_id} (Site ${site_no})`;

    // ===== User Management =====
    document.getElementById("addUserForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const payload = {
        admin_id, site_no,
        new_id: fd.get("new_id"),
        password: fd.get("password"),
        role: fd.get("role"),
      };
      const res = await fetch(`/api/site_${site_no}/admin-add-user`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      const result = await res.json();
      document.getElementById("addUserMsg").innerText = result.message;
      loadStats(); loadUsers();
    });

    document.getElementById("removeUserForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const payload = { admin_id, site_no, user_id: fd.get("user_id") };
      const res = await fetch(`/api/site_${site_no}/admin-remove-user`, {
        method: "DELETE",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      const result = await res.json();
      document.getElementById("removeUserMsg").innerText = result.message;
      loadStats(); loadUsers();
    });

    // ===== Tabs =====
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).style.display = 'block';
      });
    });

    // ===== Data Loading =====
    async function loadStats() {
      const res = await fetch(`/api/site_${site_no}/admin-stats/${site_no}`);
      const data = await res.json();
      document.getElementById('siteStats').innerText =
        `Users: ${data.current_users}/${data.max_users ?? 'Unlimited'}`;
    }

    async function loadUsers() {
      const res = await fetch(`/api/site_${site_no}/admin-users/${site_no}`);
      const data = await res.json();
      const tbody = document.querySelector("#usersTable tbody");
      tbody.innerHTML = "";
      data.forEach(u => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${u.id}</td><td>${u.role}</td><td>${u.created_at || ''}</td>`;
        tbody.appendChild(tr);
      });
    }

    async function loadToday() {
      const res = await fetch(`/api/site_${site_no}/admin-car-today/${site_no}`);
      const data = await res.json();
      const tbody = document.querySelector("#todayTable tbody");
      tbody.innerHTML = "";
      data.forEach(c => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${c.car_no}</td><td>${c.valet_id || ''}</td>
          <td>${c.driver_assigned_for_parking || ''}</td>
          <td>${c.driver_assigned_for_bringing || ''}</td>
          <td>${c.status}</td><td>${c.parking_spot || ''}</td>
          <td>${c.timestamp_car_in_request || ''}</td>
          <td>${c.timestamp_parked || ''}</td>
          <td>${c.timestamp_car_handed_over || ''}</td>`;
        tbody.appendChild(tr);
      });
    }

    async function loadHistory() {
      const date = document.getElementById("historyDate").value;
      if (!date) { alert("Please select a date"); return; }
      const res = await fetch(`/api/site_${site_no}/admin-car-history/${site_no}/${date}`);
      const data = await res.json();
      const tbody = document.querySelector("#historyTable tbody");
      tbody.innerHTML = "";
      data.forEach(c => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${c.car_no}</td><td>${c.valet_id || ''}</td>
          <td>${c.driver_assigned_for_parking || ''}</td>
          <td>${c.driver_assigned_for_bringing || ''}</td>
          <td>${c.status}</td><td>${c.parking_spot || ''}</td>
          <td>${c.timestamp_car_in_request || ''}</td>
          <td>${c.timestamp_driver_assigned || ''}</td>
          <td>${c.timestamp_parked || ''}</td>
          <td>${c.timestamp_car_out_request || ''}</td>
          <td>${c.timestamp_car_brought || ''}</td>
          <td>${c.timestamp_car_handed_over || ''}</td>`;
        tbody.appendChild(tr);
      });
    }

    async function searchCars() {
      const q = document.getElementById("searchQuery").value.trim();
      if (!q) { alert("Please enter a search query"); return; }
      const res = await fetch(`/api/site_${site_no}/admin-search-car/${site_no}/${q}`);
      const data = await res.json();
      const tbody = document.querySelector("#searchTable tbody");
      tbody.innerHTML = "";

      if (!Array.isArray(data)) {
        tbody.innerHTML = `<tr><td colspan="13">${data.message || 'No results'}</td></tr>`;
        return;
      }

      data.forEach(c => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${c.car_no}</td><td>${c.valet_id || ''}</td>
          <td>${c.status}</td><td>${c.parking_spot || ''}</td>
          <td>${c.driver_assigned_for_parking || ''}</td>
          <td>${c.driver_assigned_for_bringing || ''}</td>
          <td>${c.timestamp_car_in_request || ''}</td>
          <td>${c.timestamp_driver_assigned || ''}</td>
          <td>${c.timestamp_parked || ''}</td>
          <td>${c.timestamp_car_out_request || ''}</td>
          <td>${c.timestamp_car_brought || ''}</td>
          <td>${c.timestamp_car_handed_over || ''}</td>
          <td>${c.source}</td>`;
        tbody.appendChild(tr);
      });
    }

    // Initial load
    loadStats();
    loadUsers();
    loadToday();
    setInterval(loadToday, 2000);
    setInterval(loadStats, 5000);
    setInterval(loadUsers, 5000);
  </script>
</body>
</html>
